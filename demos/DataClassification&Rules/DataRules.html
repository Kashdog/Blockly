<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Blockly Demo: Toolbox</title>
    <script src="../../blockly_compressed.js"></script>
    <script src="../../blocks_compressed.js"></script>
    <script src="../../datarulegeneration_compressed.js"></script>
    <script src="./datarules.js"></script>
    <script src="../../msg/js/en.js"></script>
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }
        
        h1 {
            font-weight: normal;
            font-size: 140%;
        }
    </style>
</head>

<body>
    <div id="blocklyDiv" style="height: 600px; width: 1400px;"></div>
    <xml id="toolbox" style="display: none">
        <category name="General Functions"></category>
        <category name="Date/Time Functions"></category>
        <category name="Math Functions"></category>
        <category name="String Functions"></category>
        <category name="Tests"></category>
        <category name="Operations">
            <block id="addition" type="addition"></block>
            <block id="subtraction" type="subtraction"></block>
            <block id="multiplication" type="multiplication"></block>
            <block id="division" type="division"></block>
            <block id="power" type="power"></block>
            <block id="modulo" type="modulo"></block>
        </category>
        <category name="Variables and Literals">
            <block id="variable" type="variable"></block>
            <block id="numericliteral" type="numericliteral"></block>
            <block id="stringliteral" type="stringliteral"></block>
            <block id="dateliteral" type="dateliteral"></block>
        </category>
        <category name="Boolean">
            <block id="ifthen" type="ifthen"></block>
            <block id="ifthenelse" type="ifthenelse"></block>
            <block id="and" type="and"></block>
            <block id="or" type="or"></block>
            <block id="not" type="not"></block>
        </category>
    </xml>
    <script>
        var workspace = Blockly.inject('blocklyDiv', {
            media: '../../media/'
            , toolbox: document.getElementById('toolbox')
        });

        var xml = Blockly.Xml.textToDom('<xml xmlns="http://www.w3.org/1999/xhtml"><variables></variables></xml>');
        Blockly.Xml.domToWorkspace(xml, workspace);

        function myUpdateFunction(event) {
            var code = Blockly.DataRule.workspaceToCode(workspace);
            /*if (code.substring(code.length - 2, code.length - 1) == ";"){
                code = code.substring(0, code.length - 2);
            }*/
            document.getElementById("generatedCode").innerHTML = "Generated Code: " + code;

        }
        workspace.addChangeListener(myUpdateFunction);

        function showCode() {
            // Generate JavaScript code and display it.
            Blockly.DataRule.INFINITE_LOOP_TRAP = null;
            var code = Blockly.DataRule.workspaceToCode(workspace);
            alert(code);
        }

        function downloadXML() {
            var xml = Blockly.Xml.workspaceToDom(workspace);
            var xml_text = Blockly.Xml.domToText(xml);
            alert(xml_text);
            var dl = document.createElement('a');
            dl.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(xml_text));
            dl.setAttribute('download', 'DataClassificationBlocks.txt');
            dl.click();
        }
    </script>
    <button onClick="showCode()">Generate Rule</button>
    <button onClick="downloadXML()">Export the Blocks</button>

    <input type="file" id="fileinput" />
    <script type="text/javascript">
        function readSingleFile(evt) {
            //Retrieve the first (and only!) File from the FileList object
            var f = evt.target.files[0];
            if (f) {
                var r = new FileReader();
                r.onload = function (e) {
                    var contents = e.target.result;
                    alert(contents);
                    var xml = Blockly.Xml.textToDom(contents);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                }
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        }
        document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
    </script> Load Palette
    <input type="file" id="loadpalette" />
    <script type="text/javascript">
        function readSingleFile(evt) {
            //Retrieve the first (and only!) File from the FileList object
            var f = evt.target.files[0];
            if (f) {
                var r = new FileReader();
                r.onload = function (e) {
                    var contents = e.target.result;
                    if (window.DOMParser) {
                        parser = new DOMParser();
                        xmlDoc = parser.parseFromString(contents, "text/xml");
                    } else // Internet Explorer
                    {
                        xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                        xmlDoc.async = false;
                        xmlDoc.loadXML(contents);
                    }
                    var x = xmlDoc.getElementsByTagName('DataRuleFunction'); // get all the data rule functions tags
                    var general_functions, datetime_functions, math_functions, string_functions, datarule_tests;

                    /*
                      Gather all the category tags for blocks for the functions
                    */
                    for (var j = 0; j < document.getElementsByTagName('category').length; j++) {
                        if (document.getElementsByTagName('category')[j].getAttribute("name") == "General Functions") {
                            general_functions = document.getElementsByTagName('category')[j];
                        }
                        if (document.getElementsByTagName('category')[j].getAttribute("name") == "Date/Time Functions") {
                            datetime_functions = document.getElementsByTagName('category')[j];
                        }
                        if (document.getElementsByTagName('category')[j].getAttribute("name") == "Math Functions") {
                            math_functions = document.getElementsByTagName('category')[j];
                        }
                        if (document.getElementsByTagName('category')[j].getAttribute("name") == "String Functions") {
                            string_functions = document.getElementsByTagName('category')[j];
                        }
                    }

                    var function_names = [];
                    /*
                 
                    Create Blocks by parsing the tags
                    */
                    [].forEach.call(x, function (arrayElement) {
                        var function_name = arrayElement.getAttribute('name');
                        function_names.push(function_name);
                        var display = arrayElement.getAttribute('displayName');
                        var label = [];
                        var order_of_parameters = [];

                        function GetSubstringIndex(str, substring, n) {
                            var times = 0
                                , index = null;

                            while (times < n && index !== -1) {
                                index = str.indexOf(substring, index + 1);
                                times++;
                            }

                            return index;
                        }

                        var returnType = arrayElement.getAttribute('returnType');
                        if (returnType == "any") {
                            returnType = null;
                        }
                        var description = arrayElement.getElementsByTagName("description")[0].innerHTML;
                        //var param_displayNames = [];
                        var param_returnTypes = [];
                        for (var paramCounter = 0; paramCounter < arrayElement.getElementsByTagName("Parameter").length; paramCounter++) {
                            //param_displayNames.push(arrayElement.getElementsByTagName("Parameter")[paramCounter].getAttribute('displayName'));
                            if (arrayElement.getElementsByTagName("Parameter")[paramCounter].getAttribute('type') == "any") {
                                param_returnTypes.push(null);
                            } else {
                                param_returnTypes.push(arrayElement.getElementsByTagName("Parameter")[paramCounter].getAttribute('type'));
                            }
                        }
                        if (param_returnTypes.length > 0) {
                            for (var i = 1; i <= param_returnTypes.length; i++) {
                                if (i == 1) {
                                    label.push(display.substring(0, GetSubstringIndex(display, "%", 1)));
                                    order_of_parameters.push(parseInt(display.substring(GetSubstringIndex(display, "%", 1) + 1, GetSubstringIndex(display, "%", 1) + 2)));
                                } else if (GetSubstringIndex(display, "%", i) > 0) {
                                    label.push(display.substring(GetSubstringIndex(display, "%", i - 1) + 3, GetSubstringIndex(display, "%", i) - 1));
                                    order_of_parameters.push(parseInt(display.substring(GetSubstringIndex(display, "%", i) + 1, GetSubstringIndex(display, "%", i) + 2)));
                                }
                            }
                        }

                        if (label[0] == null) {
                            label[0] = display;
                        }
                        label.push(display.substring(GetSubstringIndex(display, "%", param_returnTypes.length) + 3));

                        console.log(param_returnTypes.length + " " + function_name);
                        var blocks = document.createElement('block'); // create a block tag
                        blocks.id = function_name; // give the block id to be the function name
                        blocks.setAttribute("type", function_name); // set the type attribute of the tag
                        //childNodes[0].nodeValue// Append the block tag into the xml toolbox categories
                        if (arrayElement.getAttribute('categoryID') == 'general') {
                            general_functions.appendChild(blocks);
                        } else if (arrayElement.getAttribute('categoryID') == 'date/time') {
                            datetime_functions.appendChild(blocks);
                        } else if (arrayElement.getAttribute('categoryID') == 'math') {
                            math_functions.appendChild(blocks);
                        } else if (arrayElement.getAttribute('categoryID') == 'string') {
                            string_functions.appendChild(blocks);
                        }
                        /*
                            Block Definition using function_name variable
                        */
                        Blockly.Blocks[function_name] = {
                            init: function () {
                                if (param_returnTypes.length == 0) {
                                    this.appendDummyInput()
                                        .appendField(label[0]);
                                } else {
                                    for (var i = 0; i < param_returnTypes.length; i++) {
                                        this.appendValueInput("input" + order_of_parameters[i])
                                            .setCheck(param_returnTypes[order_of_parameters[i] - 1])
                                            .appendField(label[i]);
                                    }
                                    if (label.length > param_returnTypes.length) {
                                        this.appendDummyInput()
                                            .appendField(label[label.length - 1]);
                                    }
                                }
                                this.setInputsInline(true);
                                this.setOutput(true, returnType);
                                this.setColour(218);
                                this.setTooltip(description);
                                this.setHelpUrl("");
                            }
                        };

                        /*
                            Block Generation using function_name variable
                        */
                        Blockly.DataRule[function_name] = function (block) {
                            var code = "";
                            var value_inputs = [];
                            if (param_returnTypes.length == 0) {
                                code = function_name + '()';
                            } else {
                                for (var i = 0; i < param_returnTypes.length; i++) {
                                    value_inputs[order_of_parameters[i] - 1] = Blockly.DataRule.valueToCode(block, 'input' + order_of_parameters[i], Blockly.DataRule.ORDER_ATOMIC);
                                }
                                code = function_name + '('
                                for (var i = 0; i < value_inputs.length - 1; i++) {
                                    code += value_inputs[i] + ", ";
                                }
                                code += value_inputs[value_inputs.length - 1] + ')';
                            }
                            //var value_input = Blockly.DataRule.valueToCode(block, 'input', Blockly.DataRule.ORDER_ATOMIC);
                            //var code = function_name + '(' + value_input + ')';
                            return [code, Blockly.DataRule.ORDER_ATOMIC];
                        };
                    });

                    x = xmlDoc.getElementsByTagName('DataRuleTest');
                    for (var k = 0; k < document.getElementsByTagName('category').length; k++) {
                        if (document.getElementsByTagName('category')[k].getAttribute("name") == "Tests") {
                            datarule_tests = document.getElementsByTagName('category')[k];
                        }
                    }
                    var test_names = '';
                    [].forEach.call(x, function (arrayElement) {
                        var function_name = arrayElement.getAttribute('name');
                        var display = arrayElement.getAttribute('displayName');
                        var display_name;
                        var display_name_after_operands;
                        var left_operand_boundary = display.indexOf("1") + 2;
                        if (display.indexOf("2") > 0) {
                            var right_operand_boundary = display.indexOf("2") - 2;
                            display_name = display.substring(left_operand_boundary, right_operand_boundary);
                            display_name_after_operands = display.substring(display.indexOf("2") + 2);
                        } else {
                            display_name = display.substring(left_operand_boundary);
                        }



                        var description = arrayElement.getElementsByTagName("description")[0].innerHTML;
                        var test_operand_type1 = arrayElement.getElementsByTagName("TestOperand")[0].getAttribute('type');
                        var test_operand_type2 = arrayElement.getElementsByTagName("TestOperand")[1].getAttribute('type');
                        if (test_operand_type1 == "any") {
                            test_operand_type1 = null;
                        }
                        if (test_operand_type2 == "any") {
                            test_operand_type2 = null;
                        }
                        if (arrayElement.getElementsByTagName("TestOperand")[1].getElementsByTagName("TestOperandConstraint").length > 0 && arrayElement.getElementsByTagName("TestOperand")[1].getElementsByTagName("TestOperandConstraint")[0].getAttribute("type") == "mustBeEmpty") {
                            Blockly.Blocks[function_name] = {
                                init: function () {
                                    this.appendValueInput("Operand1").setCheck(test_operand_type1);
                                    this.appendDummyInput().appendField(display_name);
                                    this.setInputsInline(true);
                                    this.setOutput(true, "Boolean");
                                    this.setColour(186);
                                    this.setTooltip(description);
                                    this.setHelpUrl("");
                                }
                            };
                            Blockly.DataRule[function_name] = function (block) {
                                var value_name1 = Blockly.DataRule.valueToCode(block, 'Operand1', Blockly.DataRule.ORDER_ATOMIC);
                                var code = value_name1 + ' ' + function_name + ' ';
                                return [code, Blockly.DataRule.ORDER_ATOMIC];
                            };
                        } else {
                            Blockly.Blocks[function_name] = {
                                init: function () {
                                    this.appendValueInput("Operand1").setCheck(test_operand_type1);
                                    this.appendValueInput("Operand2").setCheck(test_operand_type2).appendField(display_name);
                                    this.appendDummyInput().appendField(display_name_after_operands);
                                    this.setInputsInline(true);
                                    this.setOutput(true, "Boolean");
                                    this.setColour(186);
                                    this.setTooltip(description);
                                    this.setHelpUrl("");
                                }
                            };
                            Blockly.DataRule[function_name] = function (block) {
                                var value_name1 = Blockly.DataRule.valueToCode(block, 'Operand1', Blockly.DataRule.ORDER_ATOMIC);
                                var value_name2 = Blockly.DataRule.valueToCode(block, 'Operand2', Blockly.DataRule.ORDER_ATOMIC);
                                var code = value_name1 + ' ' + function_name + ' ' + value_name2;
                                return [code, Blockly.DataRule.ORDER_ATOMIC];
                            };
                        }
                        var blocks = document.createElement('block');
                        blocks.id = function_name;
                        blocks.setAttribute("type", function_name);
                        datarule_tests.appendChild(blocks);
                    });
                    workspace.updateToolbox(document.getElementById('toolbox'));
                }
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        }
        document.getElementById('loadpalette').addEventListener('change', readSingleFile, false);
    </script>
    Generate Blocks
    <input type="file" id="generateBlocks">
    <script type="text/javascript">
        function readSingleFile(evt) {
            //Retrieve the first (and only!) File from the FileList object
            var f = evt.target.files[0];
            if (f) {
                var r = new FileReader();
                r.onload = function (e) {
                    var contents = e.target.result;
                    if (window.DOMParser) {
                        parser = new DOMParser();
                        xmlDoc = parser.parseFromString(contents, "text/xml");
                    } else // Internet Explorer
                    {
                        xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                        xmlDoc.async = false;
                        xmlDoc.loadXML(contents);
                    }
                    var x = xmlDoc.getElementsByTagName('DataRuleFunction'); // get all the data rule functions tags
                    var function_names = [];

                    [].forEach.call(x, function (arrayElement) {
                        var function_name = arrayElement.getAttribute('name');
                        function_names.push(function_name);
                    });
                    var test_names = [];
                    x = xmlDoc.getElementsByTagName('DataRuleTest');
                    [].forEach.call(x, function (arrayElement) {
                        var test_name = arrayElement.getAttribute('name');
                        test_names.push(test_name);
                    });

                    function GetSubstringIndex(str, substring, n) {
                        var times = 0
                            , index = null;

                        while (times < n && index !== -1) {
                            index = str.indexOf(substring, index + 1);
                            times++;
                        }

                        return index;
                    }

                    function isAStringLiteral(rule) {
                        if (rule.substring(0, 1) === '\'' && rule.substring(rule.length - 1, rule.length) === '\'') {
                            return true;
                        } else {
                            return false
                        }
                    }

                    function trimStringLiteral(literal) {
                        literal = literal.substring(1, literal.length - 1)
                        return literal;
                    }

                    function fetchCode(rule) {
                        var block;
                        switch (true) {
                        case (!isNaN(rule)):
                            block = '<block type="numericliteral" id="numericliteral"><field name="numericInput">' + rule + '</field></block>';
                            break;
                        case (isAStringLiteral(rule)):
                            block = '<block type="stringliteral" id="stringliteral"><field name="stringInput">' + trimStringLiteral(rule) + '</field></block>';
                            break;
                        case (isAFunction(rule)):
                               break; 
                        default:
                            block = '<block type="variable" id="variable"><field name="variable">' + rule + '</field></block>';
                        }
                        return block;

                    }

                    var ruletoBlocks_precedent = '<xml xmlns="http://www.w3.org/1999/xhtml"><variables></variables>';
                    var ruletoBlocks_aftercedent = '</xml>'
                    var ruleBlocks_condition = "";
                    var ruleBlocks_action = "";
                    var ruleBlocks_alternateaction = "";
                    var res = document.getElementById("ruleToBlocks").innerHTML.replace('&lt;&gt;', '<>').replace('&lt;', '<').replace('&gt;', '>').replace('&lt;=', '<=').replace('&gt;=', '>=').split(" "); 
                    var before_condition;
                    var after_condition;
                    var before_action;
                    var after_action;
                    var before_alternateaction;
                    var after_alternateaction;
                    var if_index = res.indexOf("IF");
                    var then_index = res.indexOf("THEN");
                    var else_index = res.indexOf("ELSE");
                    var and_index = [false, false];
                    for(var i = 1; i <= 2; i++){
                        if(GetSubstringIndex(res, "AND",i) != -1){
                            and_index[i-1] = true;
                        }
                    }
                    console.log(and_index);
                    if (if_index == 0 && else_index == -1) {
                        ruletoBlocks_precedent += '<block type="ifthen" id="ifthen" x="85" y="23">';
                        ruletoBlocks_aftercedent = '</block>' + ruletoBlocks_aftercedent;
                        [].forEach.call(test_names, function (testName) {
                            if (res.indexOf(testName) != -1) {
                                for (var i = 1; i <= 2; i++) {
                                    if (GetSubstringIndex(res, testName, i) != -1 && GetSubstringIndex(res, testName, i) < then_index) {
                                        ruleBlocks_condition += '<value name="Condition"><block type="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '" id="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '">';
                                        before_condition = res.slice(1, GetSubstringIndex(res, testName, i));
                                        after_condition = res.slice(GetSubstringIndex(res, testName, i) + 1, then_index);
                                        ruleBlocks_condition += '<value name="Operand1">' + fetchCode(before_condition[0]) + '</value>';
                                        ruleBlocks_condition += '<value name="Operand2">' + fetchCode(after_condition[0]) + '</value>';
                                        ruleBlocks_condition += '</block></value>';
                                    } else if (GetSubstringIndex(res, testName, i) != -1 && GetSubstringIndex(res, testName, i) > then_index) {
                                        ruleBlocks_action += '<value name="Action"><block type="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '" id="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '">';
                                        before_action = res.slice(then_index + 1, GetSubstringIndex(res, testName, i));
                                        after_action = res.slice(GetSubstringIndex(res, testName, i) + 1);
                                        ruleBlocks_action += '<value name="Operand1">' + fetchCode(before_action[0]) + '</value>';
                                        ruleBlocks_action += '<value name="Operand2">' + fetchCode(after_action[0]) + '</value>';
                                        ruleBlocks_action += '</block></value>';
                                    }
                                }


                            }
                        });
                    } else if (if_index == 0 && else_index != -1) {
                        ruletoBlocks_precedent += '<block type="ifthenelse" id="ifthenelse" x="85" y="23">';
                        ruletoBlocks_aftercedent = '</block>' + ruletoBlocks_aftercedent;
                        [].forEach.call(test_names, function (testName) {
                            if (res.indexOf(testName) != -1) {
                                for (var i = 1; i <= 2; i++) {
                                    if (GetSubstringIndex(res, testName, i) != -1 && GetSubstringIndex(res, testName, i) < then_index) {
                                        ruleBlocks_condition += '<value name="Condition"><block type="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '" id="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '">';
                                        before_condition = res.slice(1, GetSubstringIndex(res, testName, i));
                                        after_condition = res.slice(GetSubstringIndex(res, testName, i) + 1, then_index);
                                        ruleBlocks_condition += '<value name="Operand1">' + fetchCode(before_condition[0]) + '</value>';
                                        ruleBlocks_condition += '<value name="Operand2">' + fetchCode(after_condition[0]) + '</value>';
                                        ruleBlocks_condition += '</block></value>';
                                    } else if (GetSubstringIndex(res, testName, i) != -1 && GetSubstringIndex(res, testName, i) > then_index && GetSubstringIndex(res, testName, i) < else_index) {
                                        ruleBlocks_action += '<value name="Action"><block type="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '" id="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '">';
                                        before_action = res.slice(then_index + 1, GetSubstringIndex(res, testName, i));
                                        after_action = res.slice(GetSubstringIndex(res, testName, i) + 1, else_index);
                                        ruleBlocks_action += '<value name="Operand1">' + fetchCode(before_action[0]) + '</value>';
                                        ruleBlocks_action += '<value name="Operand2">' + fetchCode(after_action[0]) + '</value>';
                                        ruleBlocks_action += '</block></value>';
                                    } else if (GetSubstringIndex(res, testName, i) != -1 && GetSubstringIndex(res, testName, i) > else_index) {
                                        ruleBlocks_alternateaction += '<value name="AlternateAction"><block type="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '" id="' + testName.replace('<>', '&lt;&gt;').replace('<', '&lt;').replace('>', '&gt;').replace('<=', '&lt;=').replace('>=', '&gt;=') + '">';
                                        before_alternateaction = res.slice(else_index + 1, GetSubstringIndex(res, testName, i));
                                        after_alternateaction = res.slice(GetSubstringIndex(res, testName, i) + 1);
                                        ruleBlocks_alternateaction += '<value name="Operand1">' + fetchCode(before_alternateaction[0]) + '</value>';
                                        ruleBlocks_alternateaction += '<value name="Operand2">' + fetchCode(after_alternateaction[0]) + '</value>';
                                        ruleBlocks_alternateaction += '</block></value>';
                                    }
                                }


                            }
                        });
                    }

                    var xml = Blockly.Xml.textToDom(ruletoBlocks_precedent + ruleBlocks_condition + ruleBlocks_action + ruleBlocks_alternateaction + ruletoBlocks_aftercedent);
                    Blockly.Xml.domToWorkspace(xml, workspace);

                }
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        }
        document.getElementById('generateBlocks').addEventListener('change', readSingleFile, false);
    </script>
    <br>
    <br>
    <div id="generatedCode">Generated code: </div>
    <div id="ruleToBlocks">IF variable = 'val' THEN variable = 'val'</div>
</body>

</html>